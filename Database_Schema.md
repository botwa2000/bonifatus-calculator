Database Schema Design Considerations

Core Design Principles

1. Security First

- Row Level Security (RLS) policies on every table
- Soft deletes for compliance and audit trails
- Separate sensitive data where possible
- Encrypted fields for highly sensitive data

2. Multi-Tenancy

- Users own their data
- Parents can access linked children's data
- Children isolated from other children
- No cross-family data access

3. Flexibility

- Support multiple grading systems per user
- Customizable bonus factors per parent/child
- Multi-language support
- Support divorced/separated parents (multiple parents per child)

4. Compliance

- GDPR: Data export, deletion, audit trails
- COPPA: Parental consent tracking, limited data collection
- Audit logging for all sensitive operations

5. Performance

- Proper indexing for common queries
- Denormalization where appropriate
- Efficient joins for parent-child relationships
- Query optimization for dashboards

---

Schema Design

1. Authentication & User Management

users (managed by Supabase Auth)

Supabase provides this table automatically - we extend it with a profile table.

Core fields from Supabase:

- id (uuid, PK) - Auto-generated by Supabase
- email (text) - Managed by Supabase Auth
- encrypted_password (text) - Managed by Supabase Auth
- email_confirmed_at (timestamptz) - Email verification status
- last_sign_in_at (timestamptz) - Last login time
- created_at (timestamptz)
- updated_at (timestamptz)

Why Supabase handles this: Authentication is complex and security-critical. Supabase provides battle-tested OAuth, email verification, password reset, and session management.

user_profiles

Extended user information - our application data.

Fields:

- id (uuid, PK, FK → users.id) - One-to-one with auth.users
- role (enum: 'parent', 'child') - User type
- full_name (text, not null) - Display name
- date_of_birth (date) - Age verification, COPPA compliance
- avatar_url (text, nullable) - Profile picture URL (Supabase Storage)
- preferred_language (text, default: 'en', FK → languages.code) - UI language
- theme_preference (enum: 'light', 'dark', 'system', default: 'system')
- timezone (text, default: 'UTC') - For date/time display
- notification_preferences (jsonb, default: {}) - Email, push notification settings
- onboarding_completed (boolean, default: false) - First-time user tutorial
- terms_accepted_at (timestamptz, nullable) - Terms of service acceptance
- privacy_policy_accepted_at (timestamptz, nullable) - Privacy policy acceptance
- is_active (boolean, default: true) - Soft delete flag
- deleted_at (timestamptz, nullable) - Soft delete timestamp
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Indexes:

- idx_user_profiles_role on role - Filter by user type
- idx_user_profiles_is_active on is_active - Exclude deleted users

RLS Policy:

- Users can read/update their own profile
- Parents can read linked children's profiles (via parent_child_relationships)

Why separate from Supabase users: Keeps authentication concerns separate from application data. Allows us to soft-delete without affecting Supabase Auth.

---

parent_child_relationships

Links parents to children (many-to-many for divorced/separated families).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- parent_id (uuid, not null, FK → user_profiles.id)
- child_id (uuid, not null, FK → user_profiles.id)
- relationship_type (enum: 'parent', 'guardian', 'tutor', default: 'parent') - For future expansion
- invitation_status (enum: 'pending', 'accepted', 'rejected', default: 'pending')
- invited_at (timestamptz, default: now())
- responded_at (timestamptz, nullable) - When child accepted/rejected
- invited_by (uuid, not null, FK → user_profiles.id) - Who created the link
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- unique_parent_child UNIQUE (parent_id, child_id) - No duplicate relationships
- CHECK (parent_id != child_id) - Can't link to self
- CHECK that parent_id has role='parent'
- CHECK that child_id has role='child'

Indexes:

- idx_relationships_parent on parent_id - Find all children for a parent
- idx_relationships_child on child_id - Find all parents for a child
- idx_relationships_status on invitation_status - Find pending invitations

RLS Policy:

- Parents can create invitations to children
- Both parent and child can read their relationships
- Children can update invitation_status (accept/reject)
- Either party can delete the relationship

Design Rationale: Supports complex family structures (divorced parents, guardians, tutors). Invitation system prevents unauthorized linking.

---

2. Internationalization & Localization

languages

Supported application languages.

Fields:

- code (text, PK) - ISO 639-1 code (en, de, fr)
- name_native (text, not null) - Native name (English, Deutsch, Français)
- name_english (text, not null) - English name
- text_direction (enum: 'ltr', 'rtl', default: 'ltr') - For future Arabic support
- is_active (boolean, default: true) - Can be selected by users
- display_order (integer, default: 0) - Sort order in language selector
- created_at (timestamptz, default: now())

Initial Data:

- en - English
- de - Deutsch (German)
- fr - Français (French)

RLS Policy: Public read access (no authentication required)

Design Rationale: Centralized language configuration. Easy to add new languages without code changes.

---

translations

Application text in multiple languages.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- translation_key (text, not null) - Unique identifier (e.g., 'auth.login.title')
- language_code (text, not null, FK → languages.code)
- translation_value (text, not null) - Translated text
- context (text, nullable) - Additional context for translators
- category (text, not null) - Grouping (auth, dashboard, calculator, etc.)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- unique_translation UNIQUE (translation_key, language_code)

Indexes:

- idx_translations_key_lang on (translation_key, language_code) - Primary lookup
- idx_translations_category on category - Batch loading by feature

RLS Policy: Public read access

Design Rationale: Database-driven translations allow dynamic updates without deployment. Translators can contribute directly.

---

3. Grading Systems & Academic Data

grading_systems

International grading scale definitions.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- code (text, unique, not null) - Unique identifier (us_af, de_16, percentage)
- name (jsonb, not null) - Localized names: {"en": "A-F System", "de": "A-F System"}
- description (jsonb, not null) - Localized descriptions
- country_code (text, nullable) - ISO 3166-1 alpha-2 (US, DE, FR)
- scale_type (enum: 'letter', 'numeric', 'percentage') - Grade format
- min_value (numeric, not null) - Lowest grade value
- max_value (numeric, not null) - Highest grade value
- best_is_highest (boolean, not null) - true: A=best, false: 1=best
- passing_threshold (numeric, not null) - Minimum passing grade
- grade_definitions (jsonb, not null) - Array of grade objects with conversion
- display_order (integer, default: 0) - Sort order in selector
- is_active (boolean, default: true)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Example grade_definitions for A-F:
[
{"grade": "A", "numeric_value": 95, "normalized_100": 95, "quality_tier": "best", "label": {"en": "Excellent", "de": "Ausgezeichnet"}},
{"grade": "B", "numeric_value": 85, "normalized_100": 85, "quality_tier": "second", "label": {"en": "Good", "de": "Gut"}},
{"grade": "C", "numeric_value": 75, "normalized_100": 75, "quality_tier": "third", "label": {"en": "Satisfactory", "de": "Befriedigend"}},
{"grade": "D", "numeric_value": 65, "normalized_100": 65, "quality_tier": "below", "label": {"en": "Below Average", "de": "Ausreichend"}},
{"grade": "F", "numeric_value": 50, "normalized_100": 50, "quality_tier": "below", "label": {"en": "Failing", "de": "Ungenügend"}}
]

Indexes:

- idx_grading_systems_code on code - Lookup by identifier
- idx_grading_systems_country on country_code - Filter by country
- idx_grading_systems_active on is_active - Active systems only

RLS Policy: Public read access

Design Rationale: JSON for flexible grade definitions and localization. Supports complex grading systems without schema changes. Normalized values enable comparison across  
 systems.

---

subject_categories

Top-level organization for subjects.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- name (jsonb, not null) - {"en": "STEM", "de": "MINT", "fr": "STIM"}
- description (jsonb, nullable) - Localized descriptions
- icon (text, nullable) - Icon identifier or emoji
- display_order (integer, default: 0)
- is_active (boolean, default: true)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Initial Categories:

- STEM (Science, Technology, Engineering, Math)
- Languages
- Social Sciences
- Arts
- Physical Education
- Vocational/Electives

RLS Policy: Public read access

Design Rationale: Organizes large subject lists. Localized for international users.

---

subjects

Academic subjects (both system-provided and user-created).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- category_id (uuid, not null, FK → subject_categories.id)
- name (jsonb, not null) - Localized names
- description (jsonb, nullable) - Localized descriptions
- is_core_subject (boolean, default: false) - Major subjects vs. electives
- is_custom (boolean, default: false) - User-created vs. system
- created_by (uuid, nullable, FK → user_profiles.id) - NULL for system subjects
- is_active (boolean, default: true)
- display_order (integer, default: 0)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Indexes:

- idx_subjects_category on category_id - Filter by category
- idx_subjects_custom on is_custom - Separate system and custom
- idx_subjects_created_by on created_by - User's custom subjects
- idx_subjects_name_gin GIN index on name using gin_trgm_ops - Full-text search

RLS Policy:

- Public read for system subjects (is_custom = false)
- Users can read their own custom subjects
- Users can create custom subjects

Design Rationale: Extensive system library plus custom subjects. Searchable across languages. Users can't see others' custom subjects (privacy).

---

4. Academic Performance Data

term_grades

Container for a term's grades (one row per school term per child).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- child_id (uuid, not null, FK → user_profiles.id)
- school_year (text, not null) - "2024-2025"
- term_type (enum: 'midterm', 'final', 'quarterly', 'semester') - Flexible term types
- grading_system_id (uuid, not null, FK → grading_systems.id)
- class_level (integer, not null) - Grade level (1-12+)
- term_name (text, nullable) - Optional custom name ("Fall Semester")
- term_start_date (date, nullable) - When term started
- term_end_date (date, nullable) - When term ended
- status (enum: 'draft', 'submitted', 'approved', default: 'draft')
- submitted_at (timestamptz, nullable) - When child finalized
- approved_by (uuid, nullable, FK → user_profiles.id) - Parent who approved
- approved_at (timestamptz, nullable)
- total_bonus_points (numeric, default: 0) - Calculated total
- notes (text, nullable) - Comments from child or parent
- is_deleted (boolean, default: false) - Soft delete
- deleted_at (timestamptz, nullable)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- CHECK (child_id references user with role='child')
- CHECK (class_level > 0)
- CHECK (approved_by references user with role='parent' OR NULL)

Indexes:

- idx_term_grades_child on child_id - All terms for a child
- idx_term_grades_child_year on (child_id, school_year) - Terms in a year
- idx_term_grades_status on status - Pending approvals
- idx_term_grades_not_deleted on is_deleted WHERE is_deleted = false - Active terms

RLS Policy:

- Children can create/read/update their own terms
- Parents can read/update terms for linked children
- Approval requires parent role

Design Rationale: Flexible term structure accommodates different school systems. Status workflow supports optional parent approval. Soft delete preserves history.

---

subject_grades

Individual grades within a term (one row per subject per term).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- term_grade_id (uuid, not null, FK → term_grades.id)
- subject_id (uuid, not null, FK → subjects.id)
- grade_value (text, not null) - Raw grade ("A", "5", "87%")
- grade_numeric (numeric, not null) - Numeric representation
- grade_normalized_100 (numeric, not null) - Converted to 0-100 scale
- grade_quality_tier (enum: 'best', 'second', 'third', 'below') - For multiplier
- subject_weight (numeric, default: 1.0) - Custom importance multiplier
- bonus_points (numeric, default: 0) - Calculated for this subject
- notes (text, nullable) - Comments about this grade
- is_deleted (boolean, default: false)
- deleted_at (timestamptz, nullable)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- unique_term_subject UNIQUE (term_grade_id, subject_id, is_deleted) WHERE is_deleted = false
- CHECK (grade_normalized_100 BETWEEN 0 AND 100)
- CHECK (subject_weight > 0)

Indexes:

- idx_subject_grades_term on term_grade_id - All grades for a term
- idx_subject_grades_subject on subject_id - History for a subject

RLS Policy:

- Inherits access from term_grades (joins required)
- Children can create/update for their terms
- Parents can read for linked children

Design Rationale: Stores both raw and normalized grades for flexibility. Pre-calculated bonus points for performance. Subject weight allows custom importance.

---

5. Bonus Calculation Configuration

bonus_factor_defaults

System-wide default multipliers (can be overridden per user).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- factor_type (enum: 'class_level', 'term_type', 'grade_tier') - What this multiplies
- factor_key (text, not null) - Identifier (e.g., 'class_1', 'midterm', 'best')
- factor_value (numeric, not null) - Multiplier value
- description (jsonb, not null) - Localized description
- is_active (boolean, default: true)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- unique_default_factor UNIQUE (factor_type, factor_key)

Initial Data:
-- Class level: higher grades = higher multiplier
('class_level', 'class_1', 1.0)
('class_level', 'class_2', 2.0)
...
('class_level', 'class_12', 12.0)

-- Term type
('term_type', 'midterm', 0.5)
('term_type', 'final', 1.0)
('term_type', 'quarterly', 0.25)
('term_type', 'semester', 0.5)

-- Grade quality tier
('grade_tier', 'best', 2.0)
('grade_tier', 'second', 1.0)
('grade_tier', 'third', 0.0)
('grade_tier', 'below', -1.0)

RLS Policy: Public read access

Design Rationale: Centralized defaults make it easy to adjust calculation. Users can override per their needs.

---

user_bonus_factors

User-specific overrides to default multipliers.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- user_id (uuid, not null, FK → user_profiles.id) - Parent who customized
- child_id (uuid, nullable, FK → user_profiles.id) - Specific child or NULL for all
- factor_type (enum: 'class_level', 'term_type', 'grade_tier')
- factor_key (text, not null)
- factor_value (numeric, not null)
- notes (text, nullable) - Why they customized
- is_active (boolean, default: true)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- unique_user_factor UNIQUE (user_id, child_id, factor_type, factor_key)
- CHECK (user_id has role='parent')
- CHECK (child_id has role='child' OR NULL)

Indexes:

- idx_user_factors_user_child on (user_id, child_id) - User's overrides
- idx_user_factors_child on child_id - Child-specific factors

RLS Policy:

- Parents can create/read/update their own factors
- Children can read factors that apply to them

Design Rationale: Allows per-parent and per-child customization. Falls back to defaults if no override. NULL child_id means applies to all parent's children.

---

6. Reward System

reward_catalog

Rewards parents define that children can earn.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- parent_id (uuid, not null, FK → user_profiles.id)
- name (text, not null) - Reward name
- description (text, nullable) - Details about the reward
- point_cost (numeric, not null) - How many bonus points required
- category (enum: 'toy', 'privilege', 'experience', 'money', 'other')
- image_url (text, nullable) - Picture of the reward (Supabase Storage)
- availability_type (enum: 'one_time', 'recurring', 'limited') - Can be earned once or multiple times
- quantity_available (integer, nullable) - NULL = unlimited, number = limited stock
- quantity_redeemed (integer, default: 0) - How many times redeemed
- is_active (boolean, default: true) - Still available
- display_order (integer, default: 0)
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- CHECK (point_cost > 0)
- CHECK (user_id has role='parent')
- CHECK (quantity_available IS NULL OR quantity_available >= 0)

Indexes:

- idx_reward_catalog_parent on parent_id - Parent's rewards
- idx_reward_catalog_active on is_active WHERE is_active = true
- idx_reward_catalog_category on category - Filter by type

RLS Policy:

- Parents can create/read/update/delete their rewards
- Children can read rewards from linked parents

Design Rationale: Flexible reward system. Parents control what's available. Limited quantity prevents over-redemption.

---

reward_redemptions

Requests by children to redeem bonus points for rewards.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- reward_id (uuid, not null, FK → reward_catalog.id)
- child_id (uuid, not null, FK → user_profiles.id)
- parent_id (uuid, not null, FK → user_profiles.id) - Which parent approves
- points_cost (numeric, not null) - Locked-in cost at time of request
- status (enum: 'pending', 'approved', 'rejected', 'cancelled', default: 'pending')
- requested_at (timestamptz, default: now())
- responded_by (uuid, nullable, FK → user_profiles.id) - Parent who responded
- responded_at (timestamptz, nullable)
- response_notes (text, nullable) - Why approved/rejected
- fulfilled_at (timestamptz, nullable) - When reward actually given
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- CHECK (child_id has role='child')
- CHECK (parent_id has role='parent')
- CHECK (points_cost > 0)

Indexes:

- idx_redemptions_child on child_id - Child's redemption history
- idx_redemptions_parent on parent_id - Parent's approval queue
- idx_redemptions_status on status WHERE status = 'pending' - Pending approvals
- idx_redemptions_reward on reward_id - Track reward popularity

RLS Policy:

- Children can create redemptions and read their own
- Parents can read/update redemptions for linked children

Design Rationale: Workflow prevents automatic spending. Parent approval ensures rewards appropriate. Points locked at request time (even if catalog price changes).

---

bonus_point_transactions

Complete audit trail of all point changes.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- child_id (uuid, not null, FK → user_profiles.id)
- transaction_type (enum: 'earned', 'redeemed', 'adjusted', 'refunded')
- amount (numeric, not null) - Positive for earning, negative for spending
- balance_after (numeric, not null) - Running balance
- source_type (enum: 'term_grade', 'redemption', 'manual') - What caused this
- source_id (uuid, nullable) - FK to term_grades, reward_redemptions, etc.
- description (text, not null) - Human-readable explanation
- created_by (uuid, not null, FK → user_profiles.id) - Who made the transaction
- notes (text, nullable) - Additional context
- created_at (timestamptz, default: now())

Indexes:

- idx_point_transactions_child on child_id - Child's transaction history
- idx_point_transactions_child_created on (child_id, created_at DESC) - Recent first
- idx_point_transactions_type on transaction_type - Filter by type

RLS Policy:

- Children can read their own transactions
- Parents can read transactions for linked children
- Only system can create transactions (via triggers)

Design Rationale: Immutable audit trail. Every point change recorded. Running balance prevents calculation errors. Cannot be deleted (compliance).

---

7. Security & Session Management

Supabase Auth Tables (Managed)

Supabase provides these automatically:

- auth.users - Core authentication
- auth.sessions - Active sessions with JWTs
- auth.refresh_tokens - Token rotation
- auth.identities - OAuth provider links

We rely on Supabase for:

- Session token generation and validation
- Refresh token rotation
- OAuth state management
- Email verification tokens
- Password reset tokens

Design Rationale: Leverage Supabase's battle-tested auth system. Don't reinvent the wheel for security-critical code.

---

security_events

Security-relevant events for monitoring and alerts.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- event_type (enum: 'login_success', 'login_failure', 'password_reset', 'email_change', 'suspicious_activity', 'account_lockout', 'rate_limit_exceeded')
- user_id (uuid, nullable, FK → user_profiles.id) - NULL if user not identified
- ip_address (inet, not null) - Source IP
- user_agent (text, nullable) - Browser/device info
- event_metadata (jsonb, default: {}) - Additional context
- severity (enum: 'info', 'warning', 'critical', default: 'info')
- created_at (timestamptz, default: now())

Indexes:

- idx_security_events_user on user_id - User's security history
- idx_security_events_type_created on (event_type, created_at DESC) - Recent events by type
- idx_security_events_severity on severity WHERE severity = 'critical' - Critical events
- idx_security_events_ip on ip_address - Track suspicious IPs

RLS Policy:

- Users can read their own security events
- Admin role can read all (future)
- Only system can insert

Design Rationale: Centralized security monitoring. Detects brute force, credential stuffing, unusual patterns. Critical for incident response.

---

rate_limit_tracking

Rate limiting state (alternative to Redis for simplicity initially).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- identifier (text, not null) - User ID, IP address, or combination
- action_type (enum: 'login', 'register', 'password_reset', 'api_request', 'email_send')
- window_start (timestamptz, not null) - Start of rate limit window
- attempt_count (integer, default: 1) - Attempts in this window
- last_attempt_at (timestamptz, default: now())
- is_locked (boolean, default: false) - Currently locked out
- locked_until (timestamptz, nullable) - When lockout expires

Constraints:

- unique_rate_limit UNIQUE (identifier, action_type, window_start)

Indexes:

- idx_rate_limit_identifier on (identifier, action_type) - Lookup for rate check
- idx_rate_limit_cleanup on window_start WHERE window_start < now() - interval '1 hour' - Cleanup old records

RLS Policy: No RLS (system table, not user-accessible)

Design Rationale: Simple database-based rate limiting. Can migrate to Redis later for better performance. Automatic cleanup of old records.

---

8. Audit & Compliance

audit_logs

Comprehensive audit trail for compliance (GDPR, COPPA).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- user_id (uuid, nullable, FK → user_profiles.id) - Who performed the action
- action (text, not null) - What happened (user.created, grade.updated, etc.)
- resource_type (text, not null) - Table affected (user_profiles, term_grades, etc.)
- resource_id (uuid, nullable) - Specific record affected
- old_values (jsonb, nullable) - Before state (for updates/deletes)
- new_values (jsonb, nullable) - After state (for creates/updates)
- ip_address (inet, nullable) - Source IP
- user_agent (text, nullable) - Browser/device
- session_id (uuid, nullable) - Supabase session ID
- created_at (timestamptz, default: now())

Indexes:

- idx_audit_logs_user on user_id - User's audit trail
- idx_audit_logs_resource on (resource_type, resource_id) - History for a record
- idx_audit_logs_action on action - Filter by action type
- idx_audit_logs_created on created_at DESC - Recent activity
- idx_audit_logs_cleanup on created_at WHERE created_at < now() - interval '90 days' - Cleanup

RLS Policy:

- Parents can read audit logs for linked children
- Users can read their own audit logs
- Only system can insert
- Never delete (use retention policy)

Retention: 90 days (automated cleanup)

Design Rationale: Immutable audit trail. Required for GDPR compliance (data access logs). Helps debug issues and disputes. JSONB allows flexible event data.

---

parental_consent

Track COPPA-compliant consent for children under 13.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- child_id (uuid, not null, unique, FK → user_profiles.id)
- parent_id (uuid, not null, FK → user_profiles.id)
- consent_given (boolean, default: false)
- consent_method (enum: 'email_verification', 'in_person', 'written') - How consent obtained
- consent_ip_address (inet, nullable) - Where consent given
- consent_timestamp (timestamptz, nullable) - When consent given
- consent_withdrawn_at (timestamptz, nullable) - If consent revoked
- created_at (timestamptz, default: now())
- updated_at (timestamptz, default: now())

Constraints:

- CHECK (child_id has role='child')
- CHECK (parent_id has role='parent')

Indexes:

- idx_parental_consent_child on child_id - Lookup by child
- idx_parental_consent_pending on consent_given WHERE consent_given = false

RLS Policy:

- Parents can read/update consent for their children
- Children cannot access (parent-controlled)

Design Rationale: COPPA compliance for US users. Child accounts under 13 require verified parental consent. Tracks consent withdrawal for "right to be forgotten".

---

data_export_requests

GDPR data portability requests.

Fields:

- id (uuid, PK, default: gen_random_uuid())
- user_id (uuid, not null, FK → user_profiles.id)
- status (enum: 'pending', 'processing', 'completed', 'failed', default: 'pending')
- export_format (enum: 'json', 'csv', default: 'json')
- export_url (text, nullable) - Signed URL to download (Supabase Storage)
- export_expires_at (timestamptz, nullable) - URL expiration (24 hours)
- requested_at (timestamptz, default: now())
- completed_at (timestamptz, nullable)
- error_message (text, nullable) - If failed
- created_at (timestamptz, default: now())

Indexes:

- idx_data_exports_user on user_id - User's export history
- idx_data_exports_status on status WHERE status IN ('pending', 'processing')

RLS Policy:

- Users can create and read their own export requests
- Parents can request exports for linked children

Design Rationale: GDPR "right to data portability". Automated export generation. Secure signed URLs with expiration.

---

9. Performance & Analytics (Optional/Future)

app_analytics

Usage metrics (fully anonymized, opt-in only).

Fields:

- id (uuid, PK, default: gen_random_uuid())
- event_type (text, not null) - page_view, feature_used, etc.
- event_properties (jsonb, default: {}) - Additional context (anonymized)
- user_language (text, nullable) - For localization insights
- user_country_code (text, nullable) - Geographic distribution
- device_type (enum: 'mobile', 'tablet', 'desktop', 'unknown')
- created_at (timestamptz, default: now())

No PII: No user IDs, no emails, no names

RLS Policy: No user access (analytics only)

Design Rationale: Optional anonymized analytics. Helps understand usage patterns and improve UX. Compliant with privacy regulations.

---

Database Relationships Summary

One-to-One:

- users ↔ user_profiles (auth data vs. app data)
- child_id ↔ parental_consent (COPPA compliance)

One-to-Many:

- languages → user_profiles (preferred language)
- languages → translations (each language has many translations)
- grading_systems → term_grades (each term uses one system)
- subject_categories → subjects (subjects grouped by category)
- user_profiles (parent) → reward_catalog (parent creates rewards)
- user_profiles (child) → term_grades (child has many terms)
- user_profiles (child) → bonus_point_transactions (child's point history)
- term_grades → subject_grades (term contains many subject grades)
- reward_catalog → reward_redemptions (reward can be redeemed many times)

Many-to-Many:

- user_profiles (parent) ↔ user_profiles (child) via parent_child_relationships
- Resolved with junction table

Self-Referential:

- user_profiles references itself via parent_child_relationships

---

Indexes Strategy

Primary Indexes (created automatically):

- Primary keys on all tables
- Unique constraints where specified

Foreign Key Indexes (must create):

- All foreign key columns get indexes for join performance
- Prevents full table scans on joins

Query Optimization Indexes:

- Composite indexes for common filter combinations
- Partial indexes for common WHERE clauses (is_active = true)
- GIN indexes for JSONB fields that are searched
- Full-text search indexes for subject names

Cleanup Indexes:

- Indexes to support automated data retention (old_records WHERE created_at < threshold)

---

Row Level Security (RLS) Strategy

Universal Principles:

1. Deny by default - no access without explicit policy
2. Use authenticated user context (auth.uid())
3. Check relationships via parent_child_relationships
4. Soft deletes respected in queries (WHERE is_deleted = false)

Policy Patterns:

Own Data:
-- Users can access their own profile
USING (auth.uid() = id)

Parent Access to Children:
-- Parents can access linked children's data
USING (
EXISTS (
SELECT 1 FROM parent_child_relationships
WHERE parent_id = auth.uid()
AND child_id = <table>.child_id
AND invitation_status = 'accepted'
)
)

Public Data:
-- Anyone can read reference data
USING (true) FOR SELECT

System-Only:
-- No policies = no user access (audit_logs, security_events)

---

Migration Strategy

Phase 1: Core Tables (Immediate)

1. user_profiles
2. parent_child_relationships
3. languages
4. grading_systems
5. subject_categories
6. subjects

Phase 2: Academic Data (Week 1) 7. bonus_factor_defaults 8. user_bonus_factors 9. term_grades 10. subject_grades

Phase 3: Rewards (Week 2-3) 11. reward_catalog 12. reward_redemptions 13. bonus_point_transactions

Phase 4: Security & Compliance (Week 2) 14. security_events 15. rate_limit_tracking 16. audit_logs 17. parental_consent 18. data_export_requests

Phase 5: Internationalization (Week 10) 19. translations (seed after language support implemented)

---

Key Design Decisions Summary

1. Supabase Auth Integration: Leverage proven authentication vs. building custom
2. Soft Deletes: All user data uses soft deletes (GDPR, audit trails)
3. JSONB for Flexibility: Translations, grade definitions, event metadata
4. Normalized 0-100 Scale: All grading systems convert for comparison
5. Immutable Audit Trails: Security events, audit logs, point transactions never deleted
6. Parent-Child Junction: Supports complex families (divorced parents, guardians)
7. Approval Workflows: Optional parent approval for grades and redemptions
8. Database Rate Limiting: Start simple, migrate to Redis if needed
9. Privacy by Design: Custom subjects private, no cross-family data access
10. Compliance Tables: Explicit consent tracking, data export automation
